<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  
  <title>{% if page.title %}{{ page.title }} | {% endif %}{{ site.title }}</title>
  
  <!-- SEO -->
  {% seo %}
  
  <!-- Stylesheets -->
  <link rel="stylesheet" href="{{ '/assets/css/extensions.css' | relative_url }}">

  {% include highlightjs.html %}
  
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="{{ '/assets/images/favicon-32.png' | relative_url }}">
  <link rel="apple-touch-icon" sizes="180x180" href="{{ '/assets/images/apple-touch-icon.png' | relative_url }}">
</head>
<body>
  {% include header.html %}
  
  <main class="main-content">
    <!-- Backdrop overlay for mobile sidebar -->
    <div class="sidebar-backdrop"></div>
    
    <!-- Sidebar Toggle Button -->
    <button class="sidebar-toggle" aria-label="Toggle sidebar" aria-expanded="false">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="3" y1="12" x2="21" y2="12"></line>
        <line x1="3" y1="6" x2="21" y2="6"></line>
        <line x1="3" y1="18" x2="21" y2="18"></line>
      </svg>
    </button>
    
    <div class="extension-container">
      <!-- Main Content Column -->
      <article class="extension-content">
        <header class="extension-header">
          {% if page.icon %}
          <img src="{{ page.icon | relative_url }}" alt="{{ page.title }} icon" class="extension-icon">
          {% endif %}
          <div class="extension-title-group">
            <h1>{{ page.title }}</h1>
            {% if page.description %}
            <p class="extension-description-text">{{ page.description }}</p>
            {% endif %}
          </div>
        </header>
        
        <div class="extension-description">
          {{ content }}
        </div>
        
        <!-- Changelog Section -->
        {% if page.versions and page.versions.size > 0 %}
        <section class="extension-changelog">
          <h2>Version History</h2>
          <div class="changelog-list">
            {% for version in page.versions %}
            <div class="changelog-entry">
              <div class="changelog-header">
                <span class="changelog-version">v{{ version.version }}</span>
                <span class="changelog-date">{{ version.date }}</span>
              </div>
              {% if version.changes and version.changes.size > 0 %}
              <ul class="changelog-changes">
                {% for change in version.changes %}
                <li>{{ change }}</li>
                {% endfor %}
              </ul>
              {% endif %}
            </div>
            {% endfor %}
          </div>
        </section>
        {% endif %}
        
        <!-- Feedback Section (ratings with comments from Azure) -->
        <section class="extension-feedback" id="extension-feedback">
          <h2>Feedback</h2>
          <div id="feedback-loading" class="feedback-loading">Loading feedback...</div>
          <div id="feedback-list" class="feedback-list" style="display:none;"></div>
          <div id="feedback-empty" class="feedback-empty" style="display:none;">
            <p>No feedback yet. Rate this extension in Vault Copilot to leave a review!</p>
          </div>
        </section>
      </article>
      
      <!-- Sidebar Column -->
      <aside class="extension-sidebar">
        {% include metadata-sidebar.html %}
      </aside>
    </div>
  </main>
  
  {% include footer.html %}
  
  <script>
    // Sidebar toggle functionality
    (function() {
      const toggle = document.querySelector('.sidebar-toggle');
      const sidebar = document.querySelector('.extension-sidebar');
      const closeBtn = document.querySelector('.sidebar-close');
      const backdrop = document.querySelector('.sidebar-backdrop');
      
      function closeSidebar() {
        sidebar.classList.remove('sidebar-open');
        backdrop.classList.remove('backdrop-visible');
        toggle.setAttribute('aria-expanded', 'false');
      }
      
      function openSidebar() {
        sidebar.classList.add('sidebar-open');
        backdrop.classList.add('backdrop-visible');
        toggle.setAttribute('aria-expanded', 'true');
      }
      
      if (toggle && sidebar) {
        // Toggle button click
        toggle.addEventListener('click', function() {
          const isExpanded = this.getAttribute('aria-expanded') === 'true';
          if (isExpanded) {
            closeSidebar();
          } else {
            openSidebar();
          }
        });
        
        // Close button click
        if (closeBtn) {
          closeBtn.addEventListener('click', closeSidebar);
        }
        
        // Backdrop click
        if (backdrop) {
          backdrop.addEventListener('click', closeSidebar);
        }
        
        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', function(e) {
          if (window.innerWidth <= 900) {
            if (!sidebar.contains(e.target) && !toggle.contains(e.target) && sidebar.classList.contains('sidebar-open')) {
              closeSidebar();
            }
          }
        });
      }
    })();
    
    // Feedback & metrics from Azure API
    (function() {
      const API_BASE = 'https://vault-copilot-api.azurewebsites.net/api';
      const extensionId = '{{ page.identifier }}';
      
      if (!extensionId) return;
      
      function renderStars(rating) {
        const r = rating || 0;
        let html = '';
        for (let i = 1; i <= 5; i++) {
          if (r >= i) html += '<span class="star star-filled">★</span>';
          else if (r >= i - 0.5) html += '<span class="star star-half">★</span>';
          else html += '<span class="star star-empty">☆</span>';
        }
        return html;
      }
      
      function renderStarsText(rating) {
        const r = rating || 0;
        let text = '';
        for (let i = 1; i <= 5; i++) {
          text += r >= i ? '★' : (r >= i - 0.5 ? '★' : '☆');
        }
        return text;
      }
      
      function timeAgo(dateStr) {
        const d = new Date(dateStr);
        const now = new Date();
        const diffMs = now - d;
        const diffMins = Math.floor(diffMs / 60000);
        if (diffMins < 1) return 'just now';
        if (diffMins < 60) return diffMins + 'm ago';
        const diffHours = Math.floor(diffMins / 60);
        if (diffHours < 24) return diffHours + 'h ago';
        const diffDays = Math.floor(diffHours / 24);
        if (diffDays < 30) return diffDays + 'd ago';
        const diffMonths = Math.floor(diffDays / 30);
        if (diffMonths < 12) return diffMonths + 'mo ago';
        return Math.floor(diffMonths / 12) + 'y ago';
      }
      
      function escapeHtml(str) {
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
      }
      
      // Fetch metrics for sidebar
      fetch(API_BASE + '/metrics/' + encodeURIComponent(extensionId))
        .then(r => r.ok ? r.json() : null)
        .then(metrics => {
          if (!metrics) return;
          
          // Show rating in sidebar
          if (metrics.ratingCount > 0) {
            const ratingSection = document.getElementById('sidebar-rating');
            const starsEl = document.getElementById('sidebar-stars');
            const textEl = document.getElementById('sidebar-rating-text');
            if (ratingSection && starsEl && textEl) {
              starsEl.innerHTML = renderStars(metrics.averageRating);
              textEl.textContent = metrics.averageRating.toFixed(1) + ' (' + metrics.ratingCount + ' rating' + (metrics.ratingCount !== 1 ? 's' : '') + ')';
              ratingSection.style.display = '';
            }
          }
          
          // Show downloads in sidebar
          if (metrics.totalInstalls > 0) {
            const dlSection = document.getElementById('sidebar-downloads');
            const dlCount = document.getElementById('sidebar-downloads-count');
            if (dlSection && dlCount) {
              dlCount.textContent = metrics.totalInstalls.toLocaleString();
              dlSection.style.display = '';
            }
          }
        })
        .catch(() => {});
      
      // Fetch ratings/feedback
      fetch(API_BASE + '/ratings/' + encodeURIComponent(extensionId))
        .then(r => r.ok ? r.json() : [])
        .then(ratings => {
          const loading = document.getElementById('feedback-loading');
          const list = document.getElementById('feedback-list');
          const empty = document.getElementById('feedback-empty');
          
          if (loading) loading.style.display = 'none';
          
          if (!ratings || ratings.length === 0) {
            if (empty) empty.style.display = '';
            return;
          }
          
          if (list) {
            list.innerHTML = ratings.map(r => `
              <div class="feedback-item">
                <div class="feedback-header">
                  <span class="feedback-stars">${renderStars(r.rating)}</span>
                  <span class="feedback-date">${timeAgo(r.updatedDate)}</span>
                </div>
                ${r.comment ? '<p class="feedback-comment">' + escapeHtml(r.comment) + '</p>' : ''}
                ${r.version ? '<span class="feedback-version">v' + escapeHtml(r.version) + '</span>' : ''}
              </div>
            `).join('');
            list.style.display = '';
          }
        })
        .catch(() => {
          const loading = document.getElementById('feedback-loading');
          const empty = document.getElementById('feedback-empty');
          if (loading) loading.style.display = 'none';
          if (empty) empty.style.display = '';
        });
    })();
  </script>
</body>
</html>
